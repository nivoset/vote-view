---
import { ballotService } from '../services/ballotService';
import type { District } from '../types/ballot';

interface Props {
	selectedDistrict?: District | null;
}

const { selectedDistrict } = Astro.props;
const districts = await ballotService.getAllDistricts();
const statesMap = new Map<string, { name: string; slug: string }>();
districts.forEach((district) => {
	statesMap.set(district.stateSlug, { name: district.state, slug: district.stateSlug });
});
const states = Array.from(statesMap.values());
const defaultStateSlug = selectedDistrict?.stateSlug ?? states[0]?.slug ?? "";
---

<div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8" id="location-selector">
	<div class="mb-4">
		<label for="zip-input" class="block text-sm font-medium text-gray-700 mb-2">
			Enter Zip Code
		</label>
		<div class="flex gap-2">
			<input
				type="text"
				id="zip-input"
				placeholder="e.g., 43201"
				class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
				maxlength="5"
			/>
			<button
				type="button"
				id="zip-submit"
				class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
			>
				Lookup
			</button>
		</div>
	</div>

	<div class="flex items-center my-6">
		<div class="flex-1 border-t border-gray-300"></div>
		<span class="px-4 text-sm text-gray-500">OR</span>
		<div class="flex-1 border-t border-gray-300"></div>
	</div>

	<div class="mb-4">
		<label for="state-select" class="block text-sm font-medium text-gray-700 mb-2">
			Select State
		</label>
	<select id="state-select" class="select-dropdown w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:border-gray-400">
			<option value="">Choose a state...</option>
			{states.map(state => (
				<option value={state.slug} selected={state.slug === defaultStateSlug}>
					{state.name}
				</option>
			))}
		</select>
	</div>

	<div class="mb-4">
		<label for="district-select" class="block text-sm font-medium text-gray-700 mb-2">
			Select District
		</label>
	<select id="district-select" class="select-dropdown w-full px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-900 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-gray-200 focus:border-gray-400">
			<option value="">Choose a district...</option>
			{districts.map(district => (
				<option
					value={district.id}
					data-state-slug={district.stateSlug}
					data-district-slug={district.districtSlug}
					selected={selectedDistrict?.id === district.id}
				>
					{district.name}
				</option>
			))}
		</select>
	</div>

	{selectedDistrict && (
		<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
			<p class="text-sm text-gray-600">
				Selected: <span class="font-semibold">{selectedDistrict.name}</span>
			</p>
		</div>
	)}
</div>

<script>
	const zipInput = document.getElementById('zip-input') as HTMLInputElement;
	const zipSubmit = document.getElementById('zip-submit') as HTMLButtonElement;
	const stateSelect = document.getElementById('state-select') as HTMLSelectElement;
	const districtSelect = document.getElementById('district-select') as HTMLSelectElement;

const districtOptions = Array.from(
	districtSelect.querySelectorAll('option[data-state-slug]')
) as HTMLOptionElement[];

function filterDistrictOptions() {
	const stateSlug = stateSelect.value;
	let hasMatch = false;

	districtOptions.forEach(option => {
		const matches = !!stateSlug && option.dataset.stateSlug === stateSlug;
		option.hidden = !matches;
		option.disabled = !matches;
		if (!matches && option.selected) {
			option.selected = false;
		}
		if (matches) {
			hasMatch = true;
		}
	});

	if (!stateSlug || !hasMatch) {
		districtSelect.value = '';
	}

	districtSelect.disabled = !stateSlug || !hasMatch;
}

// Initialize on page load
filterDistrictOptions();

// Update district options when state changes
stateSelect.addEventListener('change', () => {
	filterDistrictOptions();
});

	// Handle zip code lookup
	zipSubmit.addEventListener('click', async () => {
		const zipCode = zipInput.value.trim();
		if (!zipCode || zipCode.length !== 5) {
			alert('Please enter a valid 5-digit zip code');
			return;
		}

		try {
			const response = await fetch(`/api/lookup?zip=${zipCode}`);
			if (response.ok) {
				const data = await response.json();
				if (data.district && data.district.stateSlug && data.district.districtSlug) {
					window.location.href = `/${data.district.stateSlug}/${data.district.districtSlug}`;
				} else {
					alert('No district found for this zip code. Please try manual selection.');
				}
			}
		} catch (error) {
			console.error('Error looking up zip code:', error);
			alert('Error looking up zip code. Please try manual selection.');
		}
	});

	// Handle district selection
	districtSelect.addEventListener('change', (e) => {
		const selectEl = e.target as HTMLSelectElement;
		const selectedOption = selectEl.selectedOptions[0];
		if (selectedOption?.dataset.stateSlug && selectedOption?.dataset.districtSlug) {
			window.location.href = `/${selectedOption.dataset.stateSlug}/${selectedOption.dataset.districtSlug}`;
		}
	});

	// Allow Enter key on zip input
	zipInput.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') {
			zipSubmit.click();
		}
	});
</script>

<style>
	.select-dropdown {
		appearance: none;
		background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
		background-position: calc(100% - 0.75rem) center;
		background-repeat: no-repeat;
		background-size: 1.5em 1.5em;
		padding-right: 2.5rem;
		color: inherit;
	}
</style>

